<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Docker 安装部署</title>
      <link href="/posts/64ab9d7e.html"/>
      <url>/posts/64ab9d7e.html</url>
      
        <content type="html"><![CDATA[<h3 id="Docker-安装部署"><a href="#Docker-安装部署" class="headerlink" title="Docker 安装部署"></a>Docker 安装部署</h3><p>清华源： <a href="https://mirror.tuna.tsinghua.edu.cn/help/docker-ce/">https://mirror.tuna.tsinghua.edu.cn/help/docker-ce/</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装一些依赖</span></span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载repo源</span></span><br><span class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把软件仓库地址替换为 TUNA:</span></span><br><span class="line">sed -i <span class="string">&#x27;s+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">yum makecache fast</span><br><span class="line">yum install docker-ce -y</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动服务，并设置开机自启动</span></span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure><h3 id="配置镜像加速"><a href="#配置镜像加速" class="headerlink" title="配置镜像加速"></a>配置镜像加速</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line"><span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://bnxmxzpk.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重新启动</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><h3 id="运行第一个容器"><a href="#运行第一个容器" class="headerlink" title="运行第一个容器"></a>运行第一个容器</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run alpine /bin/echo <span class="string">&quot;Hello world&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubectl describe 参数解释</title>
      <link href="/posts/cdf1d940.html"/>
      <url>/posts/cdf1d940.html</url>
      
        <content type="html"><![CDATA[<h2 id="Kubectl-describe-参数解释"><a href="#Kubectl-describe-参数解释" class="headerlink" title="Kubectl describe 参数解释"></a>Kubectl describe 参数解释</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">Name:         nginx<span class="comment"># Pod的名称</span></span><br><span class="line">Namespace:    default<span class="comment"># 默认的命令空间</span></span><br><span class="line">Priority:     0<span class="comment"># 没有优先事项</span></span><br><span class="line">Node:         node1/172.16.32.145<span class="comment"># node节点</span></span><br><span class="line">Start Time:   Sat, 01 Oct 2021 19:32:40 +0800<span class="comment"># Pod的创建时间</span></span><br><span class="line">Labels:       &lt;none&gt;<span class="comment"># 没有标签</span></span><br><span class="line">Annotations:  &lt;none&gt;<span class="comment"># 没有注释</span></span><br><span class="line">Status:       Running<span class="comment"># Pod状态</span></span><br><span class="line">IP:           10.2.1.6<span class="comment"># ClusterIP</span></span><br><span class="line">IPs:</span><br><span class="line">  IP:  10.2.1.6</span><br><span class="line">Containers:<span class="comment"># 容器</span></span><br><span class="line">  nginx:<span class="comment"># nginx容器信息</span></span><br><span class="line">    <span class="comment"># 容器ID</span></span><br><span class="line">    Container ID:   docker://00d72ec98a23db9a6f927bd54ef01c39e22e6a7b4950575f3b6c460fde971aae</span><br><span class="line">    Image:          nginx:1.14.2<span class="comment"># 镜像名称：镜像版本</span></span><br><span class="line">    <span class="comment"># 镜像ID</span></span><br><span class="line">    Image ID:       docker-pullable://nginx@sha256:f7988fb6c02e0ce69257d9bd9cf37ae20a60f1df7563c3a2a6abe24160306b8d</span><br><span class="line">    Port:           80/TCP<span class="comment"># 声明的端口</span></span><br><span class="line">    Host Port:      0/TCP<span class="comment"># 没有映射端口</span></span><br><span class="line">    State:          Running<span class="comment"># 容器状态</span></span><br><span class="line">      Started:      Sat, 01 Oct 2021 19:33:10 +0800<span class="comment"># 容器的创建时间</span></span><br><span class="line">    Ready:          True<span class="comment"># </span></span><br><span class="line">    Restart Count:  0<span class="comment"># 容器重启的次数</span></span><br><span class="line">    Environment:    &lt;none&gt;<span class="comment"># 没有传递环境变量</span></span><br><span class="line">    Mounts:<span class="comment"># 挂载</span></span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-lc5m9 (ro)</span><br><span class="line">Conditions:<span class="comment"># Pod状况</span></span><br><span class="line">  Type <span class="comment"># 类型       Status# 状态</span></span><br><span class="line">  Initialized       True<span class="comment"># 安装正常</span></span><br><span class="line">  Ready             True<span class="comment"># 准备OK</span></span><br><span class="line">  ContainersReady   True<span class="comment"># 容器OK</span></span><br><span class="line">  PodScheduled      True<span class="comment"># 正常调度</span></span><br><span class="line">Volumes:<span class="comment"># 卷</span></span><br><span class="line">  default-token-lc5m9:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret) <span class="comment"># 加密类型</span></span><br><span class="line">    SecretName:  default-token-lc5m9<span class="comment">#加密名称</span></span><br><span class="line">    Optional:    <span class="literal">false</span><span class="comment"># 可选项</span></span><br><span class="line">QoS Class:       BestEffort<span class="comment"># 服务质量类型</span></span><br><span class="line">Node-Selectors:  &lt;none&gt; <span class="comment"># 没有指定node节点</span></span><br><span class="line"><span class="comment"># 容忍</span></span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists <span class="keyword">for</span> 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute op=Exists <span class="keyword">for</span> 300s</span><br><span class="line">Events:<span class="comment"># 事件</span></span><br><span class="line">  Type    Reason     Age   From               Message</span><br><span class="line">  ----    ------     ----  ----               -------</span><br><span class="line">  Normal  Scheduled  44m   default-scheduler  Successfully assigned default/nginx to node1</span><br><span class="line">  Normal  Pulling    44m   kubelet            Pulling image <span class="string">&quot;nginx:1.14.2&quot;</span></span><br><span class="line">  Normal  Pulled     43m   kubelet            Successfully pulled image <span class="string">&quot;nginx:1.14.2&quot;</span> <span class="keyword">in</span> 29.118746698s</span><br><span class="line">  Normal  Created    43m   kubelet            Created container nginx</span><br><span class="line">  Normal  Started    43m   kubelet            Started container nginx</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes Ingress 服务</title>
      <link href="/posts/850424dd.html"/>
      <url>/posts/850424dd.html</url>
      
        <content type="html"><![CDATA[<h2 id="Kubernetes-Ingress-服务"><a href="#Kubernetes-Ingress-服务" class="headerlink" title="Kubernetes Ingress 服务"></a>Kubernetes Ingress 服务</h2><p>Ingress服务具体概念请阅读官方文档：<a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/">https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/</a></p><h3 id="安装部署nginx-ingress"><a href="#安装部署nginx-ingress" class="headerlink" title="安装部署nginx-ingress"></a>安装部署nginx-ingress</h3><p>官方的Nginx-ingress对k8s是有版本要求的，注意选择适合你的版本:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/kubernetes/ingress-nginx</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221002235609833.png" alt="image-20221002235609833"></p><p>可以直接使用kubernetes官方自带的nginx-ingress控制清单来部署</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controllerv1.3.0/</span><br><span class="line">deploy/static/provider/kind/deploy.yaml -O nginx-ingress-v1.3.0.yaml</span><br><span class="line"><span class="comment"># 上面下载不了就访问下面的链接</span></span><br><span class="line">https://github.com/kubernetes/ingress-nginx/archive/refs/tags/controllerv1.3.0.tar.gz</span><br></pre></td></tr></table></figure><p>修改deploy.yaml镜像源为国内地址</p><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003163804925.png" alt="image-20221003163804925"></p><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003163828860.png" alt="image-20221003163828860"></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">---439行</span></span><br><span class="line"><span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.3.0</span></span><br><span class="line"><span class="string">---546行</span></span><br><span class="line"><span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers/kubewebhook-certgen:v1.1.1</span></span><br><span class="line"><span class="string">---595行</span></span><br><span class="line"><span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers/kubewebhook-certgen:v1.1.1</span></span><br></pre></td></tr></table></figure><h4 id="node节点增加标签"><a href="#node节点增加标签" class="headerlink" title="node节点增加标签"></a>node节点增加标签</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes node1 ingress-ready=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="应用资源配置"><a href="#应用资源配置" class="headerlink" title="应用资源配置"></a>应用资源配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deploy.yaml</span><br></pre></td></tr></table></figure><p>查看创建的资源</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n ingress-nginx get all</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003161445687.png" alt="image-20221003161445687"></p><h3 id="创建测试的服务"><a href="#创建测试的服务" class="headerlink" title="创建测试的服务"></a>创建测试的服务</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">my-nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-nginx</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f my-nginx.yaml</span><br></pre></td></tr></table></figure><h3 id="创建Ingress规则"><a href="#创建Ingress规则" class="headerlink" title="创建Ingress规则"></a>创建Ingress规则</h3><div class="tabs" id="tab1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#tab1-1">Ingress资源清单</button></li><li class="tab"><button type="button" data-href="#tab1-2">参数说明</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="tab1-1"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">nginx.k8s.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tab1-2"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: my-nginx</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx # 匹配ingress类型为nginx</span><br><span class="line">  rules: # 转发规则</span><br><span class="line">  - host: nginx.k8s.com # 匹配的域名</span><br><span class="line">    http: # 基于http协议解析</span><br><span class="line">      paths: # 基于路径进行匹配</span><br><span class="line">      - path: / # 匹配/路径</span><br><span class="line">        pathType: ImplementationSpecific # 路径类型</span><br><span class="line">        backend: # 匹配后跳转的后端服务</span><br><span class="line">          service: # 设置后端跳转到Service的配置</span><br><span class="line">            name: my-nginx # 跳转到名为my-nginx的clusterIP</span><br><span class="line">            port: # 跳转到的端口</span><br><span class="line">              number: 80 # Service端口号</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f my-nginx-ingress.yaml</span><br></pre></td></tr></table></figure><p>pathType路径类型支持的类型：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ImplementationSpecific <span class="comment"># 系统默认，由IngressClass控制器提供</span></span><br><span class="line">Exact <span class="comment"># 精确匹配URL路径，区分大小写</span></span><br><span class="line">Prefix <span class="comment"># 匹配URL路径的前缀，区分大小写</span></span><br></pre></td></tr></table></figure><h3 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># windows、mac本地hosts添加解析</span></span><br><span class="line">172.16.32.145 nginx.k8s.com</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003162647938.png" alt="image-20221003162647938"></p>]]></content>
      
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes Pod的生命周期</title>
      <link href="/posts/bfd53626.html"/>
      <url>/posts/bfd53626.html</url>
      
        <content type="html"><![CDATA[<h2 id="Kubernetes-Pod的生命周期"><a href="#Kubernetes-Pod的生命周期" class="headerlink" title="Kubernetes Pod的生命周期"></a>Kubernetes Pod的生命周期</h2><p>具体概念请阅读官方文档：<a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-lifecycle/">https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-lifecycle/</a></p><h3 id="Pod-阶段"><a href="#Pod-阶段" class="headerlink" title="Pod 阶段"></a>Pod 阶段</h3><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221002001621554.png" alt="image-20221002001621554"></p><div class="table-container"><table><thead><tr><th style="text-align:left">取值</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left"><code>Pending</code>（悬决）</td><td style="text-align:left">Pod 已被 Kubernetes 系统接受，但有一个或者多个容器尚未创建亦未运行。此阶段包括等待 Pod 被调度的时间和通过网络下载镜像的时间。</td></tr><tr><td style="text-align:left"><code>Running</code>（运行中）</td><td style="text-align:left">Pod 已经绑定到了某个节点，Pod 中所有的容器都已被创建。至少有一个容器仍在运行，或者正处于启动或重启状态。</td></tr><tr><td style="text-align:left"><code>Succeeded</code>（成功）</td><td style="text-align:left">Pod 中的所有容器都已成功终止，并且不会再重启。</td></tr><tr><td style="text-align:left"><code>Failed</code>（失败）</td><td style="text-align:left">Pod 中的所有容器都已终止，并且至少有一个容器是因为失败终止。也就是说，容器以非 0 状态退出或者被系统终止。</td></tr><tr><td style="text-align:left"><code>Unknown</code>（未知）</td><td style="text-align:left">因为某些原因无法取得 Pod 的状态。这种情况通常是因为与 Pod 所在主机通信失败。</td></tr></tbody></table></div><h3 id="Pod-相关状态解释"><a href="#Pod-相关状态解释" class="headerlink" title="Pod 相关状态解释"></a>Pod 相关状态解释</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CrashLoopBackOff <span class="comment"># 容器退出，kubelet正在将它重启</span></span><br><span class="line">InvalidImageName <span class="comment"># 无法解析镜像名称</span></span><br><span class="line">ImageInspectError <span class="comment"># 无法校验镜像</span></span><br><span class="line">ErrImageNeverPull <span class="comment"># 策略禁止拉取镜像</span></span><br><span class="line">ImagePullBackOff <span class="comment"># 镜像正在重试拉取</span></span><br><span class="line">RegistryUnavailable <span class="comment"># 连接不到镜像中心</span></span><br><span class="line">ErrImagePull <span class="comment"># 通用的拉取镜像出错</span></span><br><span class="line">CreateContainerConfigError <span class="comment"># 不能创建kubelet使用的容器配置</span></span><br><span class="line">CreateContainerError <span class="comment"># 创建容器失败</span></span><br><span class="line">m.internalLifecycle.PreStartContainer <span class="comment"># 执行hook报错</span></span><br><span class="line">RunContainerError <span class="comment"># 启动容器失败</span></span><br><span class="line">PostStartHookError <span class="comment"># 执行hook报错</span></span><br><span class="line">ContainersNotInitialized <span class="comment"># 容器没有初始化完毕</span></span><br><span class="line">ContainersNotReady <span class="comment"># 容器没有准备完毕</span></span><br><span class="line">ContainerCreating <span class="comment"># 容器创建中</span></span><br><span class="line">PodInitializing <span class="comment"># pod初始化中</span></span><br><span class="line">DockerDaemonNotReady <span class="comment"># docker还没有完全启动</span></span><br><span class="line">NetworkPluginNotReady <span class="comment"># 网络插件还没有完全启动</span></span><br></pre></td></tr></table></figure><h3 id="容器状态"><a href="#容器状态" class="headerlink" title="容器状态"></a>容器状态</h3><ul><li>Waiting （等待）<br>如果容器并不处在 Running 或 Terminated 状态之一，它就处在 Waiting 状态。 处于 Waiting 状态的容器仍在运行它完成启动所需要的操作：例如，从某个容器镜像 仓库拉取容器镜像，或者向容器应用 Secret 数据等等。 当你使用 kubectl 来查询包含 Waiting 状态的容器的 Pod 时，你也会看到一个 Reason 字段，其中给出了容器处于等待状态的原因。</li><li>Running（运行中）<br>Running 状态表明容器正在执行状态并且没有问题发生。 如果配置了 postStart 回调，那么该回调已经执行且已完成。 如果你使用 kubectl 来查询包含 Running 状态的容器的 Pod 时，你也会看到 关于容器进入 Running 状态的信息。</li><li>Terminated（已终止）<br>处于 Terminated 状态的容器已经开始执行并且或者正常结束或者因为某些原因失败。 如果你使用 kubectl 来查询包含 Terminated 状态的容器的 Pod 时，你会看到 容器进入此状态的原因、退出代码以及容器执行期间的起止时间。</li></ul><h3 id="Pod-状况"><a href="#Pod-状况" class="headerlink" title="Pod 状况"></a>Pod 状况</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看Pod详细信息</span></span><br><span class="line">kubectl describe pod nginx</span><br><span class="line"><span class="comment"># 输入以上命令，查看Conditions、Events</span></span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221002001117663.png" alt="image-20221002001117663"></p><p>Conditions：</p><ul><li><code>PodScheduled</code>：Pod 已经被调度到某节点；</li><li><code>PodHasNetwork</code>：Pod 沙箱被成功创建并且配置了网络（Alpha 特性，必须被<a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-lifecycle/#pod-has-network">显式启用</a>）；</li><li><code>ContainersReady</code>：Pod 中所有容器都已就绪；</li><li><code>Initialized</code>：所有的 <a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/init-containers/">Init 容器</a> 都已成功完成；</li><li><code>Ready</code>：Pod 可以为请求提供服务，并且应该被添加到对应服务的负载均衡池中。</li></ul><div class="table-container"><table><thead><tr><th style="text-align:left">字段名称</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left"><code>type</code></td><td style="text-align:left">Pod 状况的名称</td></tr><tr><td style="text-align:left"><code>status</code></td><td style="text-align:left">表明该状况是否适用，可能的取值有 “<code>True</code>“, “<code>False</code>“ 或 “<code>Unknown</code>“</td></tr><tr><td style="text-align:left"><code>lastProbeTime</code></td><td style="text-align:left">上次探测 Pod 状况时的时间戳</td></tr><tr><td style="text-align:left"><code>lastTransitionTime</code></td><td style="text-align:left">Pod 上次从一种状态转换到另一种状态时的时间戳</td></tr><tr><td style="text-align:left"><code>reason</code></td><td style="text-align:left">机器可读的、驼峰编码（UpperCamelCase）的文字，表述上次状况变化的原因</td></tr><tr><td style="text-align:left"><code>message</code></td><td style="text-align:left">人类可读的消息，给出上次状态转换的详细信息</td></tr></tbody></table></div>]]></content>
      
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes Pod 资源</title>
      <link href="/posts/5c7ef3e1.html"/>
      <url>/posts/5c7ef3e1.html</url>
      
        <content type="html"><![CDATA[<h2 id="Kubernetes-Pod-资源"><a href="#Kubernetes-Pod-资源" class="headerlink" title="Kubernetes Pod 资源"></a>Kubernetes Pod 资源</h2><p>Pod资源，具体概念请阅读官方文档：<a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/">https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/</a></p><h3 id="使用Pod"><a href="#使用Pod" class="headerlink" title="使用Pod"></a>使用Pod</h3><div class="tabs" id="tab1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#tab1-1">Pod资源清单</button></li><li class="tab"><button type="button" data-href="#tab1-2">字段说明</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="tab1-1"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.14.2</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tab1-2"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 资源清单参数说明</span></span><br><span class="line">apiVersion: v1<span class="comment"># 版本</span></span><br><span class="line">kind: Pod<span class="comment"># 资源类型</span></span><br><span class="line">metadata:<span class="comment"># 元数据</span></span><br><span class="line">  name: nginx<span class="comment"># 定义该资源名称</span></span><br><span class="line">spec:<span class="comment"># 详情描述</span></span><br><span class="line">  containers:<span class="comment"># 容器 </span></span><br><span class="line">  - name: nginx<span class="comment"># 定义该容器名称</span></span><br><span class="line">    image: nginx:1.14.2<span class="comment"># 镜像名称：镜像版本</span></span><br><span class="line">    ports:<span class="comment"># 端口</span></span><br><span class="line">    - containerPort: 80<span class="comment"># 声明80端口</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 要创建上面显示的 Pod，请运行以下命令</span></span><br><span class="line">kubectl create -f pod.yaml</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">kubectl apply -f pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># create跟apply的区别，前者只能创建后者创建和更新</span></span><br></pre></td></tr></table></figure><h3 id="Pod-模板"><a href="#Pod-模板" class="headerlink" title="Pod 模板"></a>Pod 模板</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># 模板</span></span><br><span class="line">    <span class="comment"># 这里是 Pod 模板</span></span><br><span class="line">    <span class="attr">spec:</span><span class="comment"># 模板详情描述</span></span><br><span class="line">      <span class="attr">containers:</span><span class="comment"># 容器</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hello</span><span class="comment"># 定义容器名称</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox:1.28</span><span class="comment"># 镜像名称：镜像版本</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;echo &quot;Hello, Kubernetes!&quot; &amp;&amp; sleep 3600&#x27;</span>]<span class="comment"># 执行命令</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span> <span class="comment"># 重新启动策略： Always（总是），OnFailure（失败时），Never（从不）</span></span><br><span class="line">    <span class="comment"># 以上为 Pod 模板</span></span><br></pre></td></tr></table></figure><h3 id="查看运行的Pod"><a href="#查看运行的Pod" class="headerlink" title="查看运行的Pod"></a>查看运行的Pod</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221001193404601.png" alt="image-20221001193404601"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line">Name <span class="comment"># Pod资源名称</span></span><br><span class="line">READY<span class="comment"># Pod数量</span></span><br><span class="line">STATUS<span class="comment"># Pod状态</span></span><br><span class="line">RESTARTS<span class="comment"># Pod重启次数</span></span><br><span class="line">AGE<span class="comment"># Pod运行时间</span></span><br></pre></td></tr></table></figure><p>STATUS 状态具体说明<a href="https://www.opsape.com/posts/bfd53626.html">Kubernetes Pod的生命周期</a></p><h3 id="查看指定Pod的详细信息"><a href="#查看指定Pod的详细信息" class="headerlink" title="查看指定Pod的详细信息"></a>查看指定Pod的详细信息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx 是 Pod名称</span></span><br><span class="line">kubectl describe pod nginx</span><br></pre></td></tr></table></figure><p>describe 详细信息说明<a href="https://www.opsape.com/posts/cdf1d940.html">Kubectl describe 参数解释</a></p><h3 id="删除指定Pod"><a href="#删除指定Pod" class="headerlink" title="删除指定Pod"></a>删除指定Pod</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx 是Pod的名称</span></span><br><span class="line">kubectl delete pod nginx</span><br></pre></td></tr></table></figure><h3 id="删除指定资源清单的所有Pod"><a href="#删除指定资源清单的所有Pod" class="headerlink" title="删除指定资源清单的所有Pod"></a>删除指定资源清单的所有Pod</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pod.yaml 是资源清单文件</span></span><br><span class="line">kubectl delete -f pod.yaml</span><br></pre></td></tr></table></figure><h3 id="删除所有资源清单的所有Pod（当前目录）"><a href="#删除所有资源清单的所有Pod（当前目录）" class="headerlink" title="删除所有资源清单的所有Pod（当前目录）"></a>删除所有资源清单的所有Pod（当前目录）</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f .</span><br></pre></td></tr></table></figure><h3 id="查看Pod内容器的日志"><a href="#查看Pod内容器的日志" class="headerlink" title="查看Pod内容器的日志"></a>查看Pod内容器的日志</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx 是Pod的名称，nginx-2 是容器的名称</span></span><br><span class="line">kubectl logs -f nginx -c nginx-2 </span><br></pre></td></tr></table></figure><h3 id="进入容器命令"><a href="#进入容器命令" class="headerlink" title="进入容器命令"></a>进入容器命令</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx 是Pod的名称，nginx-2 是容器的名称</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it nginx -c nginx-2 -- /bin/bash</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes Pod的应用</title>
      <link href="/posts/fcf74529.html"/>
      <url>/posts/fcf74529.html</url>
      
        <content type="html"><![CDATA[<h2 id="Kubernetes-Pod的应用"><a href="#Kubernetes-Pod的应用" class="headerlink" title="Kubernetes Pod的应用"></a>Kubernetes Pod的应用</h2><h3 id="基础的Pod"><a href="#基础的Pod" class="headerlink" title="基础的Pod"></a>基础的Pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span> <span class="comment">#镜像拉取策略：只有当镜像在本地不存在时才会拉取</span></span><br></pre></td></tr></table></figure><p>具体镜像概念请阅读官方文档：<a href="https://kubernetes.io/zh-cn/docs/concepts/containers/images/">https://kubernetes.io/zh-cn/docs/concepts/containers/images/</a></p><h3 id="多个容器组成Pod"><a href="#多个容器组成Pod" class="headerlink" title="多个容器组成Pod"></a>多个容器组成Pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-tomcat</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span> <span class="comment"># 在同一个containers内写多个容器</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br></pre></td></tr></table></figure><h3 id="Pod内的容器共享存储"><a href="#Pod内的容器共享存储" class="headerlink" title="Pod内的容器共享存储"></a>Pod内的容器共享存储</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-tomcat</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span>        <span class="comment"># nginx容器挂载卷</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span>         <span class="comment"># 引用卷名为data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/code/</span>  <span class="comment"># 挂载到Pod的/code目录</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span>       <span class="comment">#tomcat容器挂载卷</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span>         <span class="comment">#引用卷名为data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/code/</span>  <span class="comment">#挂载到Pod的/code目录</span></span><br><span class="line">  <span class="attr">volumes:</span>          <span class="comment">#定义存储卷</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span>      <span class="comment">#卷名为data</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;    <span class="comment">#pod的空目录</span></span><br></pre></td></tr></table></figure><p>存储相关概念请阅读官方文档：<a href="https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/">https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/</a></p><h3 id="Pod跟宿主机共享目录"><a href="#Pod跟宿主机共享目录" class="headerlink" title="Pod跟宿主机共享目录"></a>Pod跟宿主机共享目录</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-tomcat</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/code/</span> </span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/code/</span> </span><br><span class="line"></span><br><span class="line">  <span class="attr">volumes:</span>       <span class="comment">#定义存储卷</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span>   <span class="comment">#卷名</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/code/</span>  <span class="comment">#宿主机共享的路径</span></span><br></pre></td></tr></table></figure><h3 id="Pod的初始化容器"><a href="#Pod的初始化容器" class="headerlink" title="Pod的初始化容器"></a>Pod的初始化容器</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">initContainers:</span>     <span class="comment">#在容器前整一个initContainers就是初始化容器</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">args:</span> [<span class="string">/bin/sh</span>, <span class="string">-c</span>, <span class="string">&#x27;echo k8s &gt;&gt; /usr/share/nginx/html/index.html&#x27;</span>]</span><br><span class="line">    <span class="comment"># 执行命令，和command一样，但同时存在时，args作为变量存在</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html/</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html/</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>init容器具体概念请阅读官方文档：<a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/init-containers/">https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/init-containers/</a></p><p>配置 Pod 初始化 <a href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-initialization/">https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-initialization/</a></p><h3 id="Pod的资源限制"><a href="#Pod的资源限制" class="headerlink" title="Pod的资源限制"></a>Pod的资源限制</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">resource-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">resource-demo</span></span><br><span class="line">     <span class="attr">images:</span> <span class="string">nginx</span></span><br><span class="line">     <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">     <span class="attr">resources:</span></span><br><span class="line">       <span class="attr">requests:</span></span><br><span class="line">         <span class="attr">memory:</span> <span class="string">50Mi</span></span><br><span class="line">         <span class="attr">cpu:</span> <span class="string">1500m</span></span><br><span class="line">       <span class="attr">limits:</span></span><br><span class="line">         <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">         <span class="attr">cpu:</span> <span class="string">200m</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参数解释：</span></span><br><span class="line">requests :节点所需的最⼩计算资源量，k8s调度的时候的依据值</span><br><span class="line">limits :限制允许的最⼤计算资源量,真正的资源限制参数</span><br><span class="line"><span class="comment"># 数值的转换：</span></span><br><span class="line">1 CPU = 1000m，0.5 CPU = 500m，1 Mib = 1024 Kib，1 MB = 1000 KB</span><br></pre></td></tr></table></figure><h2 id="Pod配置存活、就绪和启动探针"><a href="#Pod配置存活、就绪和启动探针" class="headerlink" title="Pod配置存活、就绪和启动探针"></a>Pod配置存活、就绪和启动探针</h2><p>具体概念请阅读官方文档：<a href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/</a></p><h3 id="POD启动和停止钩子"><a href="#POD启动和停止钩子" class="headerlink" title="POD启动和停止钩子"></a>POD启动和停止钩子</h3><p><strong>PostStart（启动钩子）：</strong>在容器启动创建后立刻执行，但是时间不能太长，否则容器将不会是running状态<br><strong>PreStop（停止钩子）：</strong>在容器停止被删除前执行，主要用于优雅的关闭应用程序</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">lifecycle:</span>     <span class="comment">#生命周期</span></span><br><span class="line">      <span class="attr">postStart:</span>   <span class="comment">#启动钩子</span></span><br><span class="line">        <span class="attr">exec:</span>      <span class="comment">#在容器运行的意思</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">/bin/sh</span>, <span class="string">-c</span>, <span class="string">&#x27;echo k8s &gt; /usr/share/nginx/html/index.html&#x27;</span>]</span><br><span class="line">      <span class="attr">preStop:</span>     <span class="comment">#停止钩子</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">/bin/sh</span>, <span class="string">-c</span>, <span class="string">&#x27;echo beybey &gt; /code/stop.log&#x27;</span>]</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/code/</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/code/</span></span><br></pre></td></tr></table></figure><h3 id="Pod的存活性探针"><a href="#Pod的存活性探针" class="headerlink" title="Pod的存活性探针"></a>Pod的存活性探针</h3><div class="tabs" id="tab1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#tab1-1">命令探针</button></li><li class="tab"><button type="button" data-href="#tab1-2">http探针</button></li><li class="tab"><button type="button" data-href="#tab1-3">端口探针</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="tab1-1"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">/bin/sh</span>, <span class="string">-c</span>, <span class="string">&#x27;echo ok &gt; /usr/share/nginx/html/index.html&#x27;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">/bin/sh</span>, <span class="string">-c</span>, <span class="string">&#x27;echo beybey &gt; /usr/share/nginx/html/stop.log&#x27;</span>]</span><br><span class="line">    <span class="attr">livenessProbe:</span>   <span class="comment"># 存活性探针</span></span><br><span class="line">      <span class="attr">exec:</span>          <span class="comment"># 在容器里运行的意思</span></span><br><span class="line">        <span class="attr">command:</span>     <span class="comment"># 执行的命令(本质是echo $? 结果非0，默认3次判断为不存活，自动重启pod)</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/bin/bash</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span> <span class="string">/usr/share/nginx/html/index.html</span>                      </span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">3</span>    <span class="comment"># 初始化延迟3秒(因为有些服务启动慢，适当提高时间)</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span>          <span class="comment"># 每3次测试一次(默认允许失败3次，3次后重启pod)</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html/</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/code/</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tab1-2"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">/bin/sh</span>, <span class="string">-c</span>, <span class="string">&#x27;echo ok &gt; /usr/share/nginx/html/index.html&#x27;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">/bin/sh</span>, <span class="string">-c</span>, <span class="string">&#x27;echo beybey &gt; /usr/share/nginx/html/stop.log&#x27;</span>]</span><br><span class="line">    <span class="attr">livenessProbe:</span>             <span class="comment"># 存活性探针</span></span><br><span class="line">      <span class="attr">httpGet:</span>                 <span class="comment"># http探针</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">www.opsape.com</span>      <span class="comment"># 多个域名选择指定域名检测</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/index.html</span>     <span class="comment"># 检测这个url，默认3次访问不成功就判断为不存活，自动重启pod</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span>               <span class="comment"># 端口为80   </span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">3</span>   <span class="comment"># 初始化延迟3秒(因为有些服务启动慢，适当提高时间)</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span>         <span class="comment"># 每3次测试一次(默认允许失败3次，3次后重启pod)</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html/</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/code/</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tab1-3"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">/bin/sh</span>, <span class="string">-c</span>, <span class="string">&#x27;echo ok &gt; /usr/share/nginx/html/index.html&#x27;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">/bin/sh</span>, <span class="string">-c</span>, <span class="string">&#x27;echo beybey &gt; /usr/share/nginx/html/stop.log&#x27;</span>]</span><br><span class="line">    <span class="attr">livenessProbe:</span>             <span class="comment"># 存活性探针</span></span><br><span class="line">      <span class="attr">tcpSocket:</span>               <span class="comment"># 端口探针</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span>               <span class="comment"># 监听端口为80，默认3次不存在就判断为不存活，自动重启pod</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">3</span>   <span class="comment"># 初始化延迟3秒(因为有些服务启动慢，适当提高时间)</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span>         <span class="comment"># 每3次测试一次(默认允许失败3次，3次后重启pod)</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html/</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/code/</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="Pod的就绪性探针"><a href="#Pod的就绪性探针" class="headerlink" title="Pod的就绪性探针"></a>Pod的就绪性探针</h3><p>就绪性探针和存活性探针一样有命令、http、端口三种方式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">/bin/sh</span>, <span class="string">-c</span>, <span class="string">&#x27;echo ok &gt; /usr/share/nginx/html/index.html&#x27;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">/bin/sh</span>, <span class="string">-c</span>, <span class="string">&#x27;echo beybey &gt; /usr/share/nginx/html/stop.log&#x27;</span>]</span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span>                          </span><br><span class="line">        <span class="attr">path:</span> <span class="string">/index.html</span>      </span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span>                        </span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">readinessProbe:</span>        <span class="comment"># 就绪性探针</span></span><br><span class="line">      <span class="attr">httpGet:</span>             <span class="comment"># http探针             </span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/index.html</span>  <span class="comment"># 这个url访问成功，就说明准备就绪，k8s就会接入流量，提供给外界访问</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">30</span>    <span class="comment"># 初始化延迟30秒(因为有些服务启动慢，适当提高时间)</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span>          <span class="comment"># 每3次测试一次(默认允许失败3次，3次后重启pod)</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html/</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/code/</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes Dp、Rs、Ds 控制器</title>
      <link href="/posts/fd4dfbf6.html"/>
      <url>/posts/fd4dfbf6.html</url>
      
        <content type="html"><![CDATA[<h2 id="Deployments-控制器"><a href="#Deployments-控制器" class="headerlink" title="Deployments 控制器"></a><strong>Deployments</strong> 控制器</h2><p><strong>Deployments</strong> 控制器，具体概念请阅读官方文档：<a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/">https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/</a></p><h3 id="使用Deployments创建POD资源清单"><a href="#使用Deployments创建POD资源清单" class="headerlink" title="使用Deployments创建POD资源清单"></a>使用Deployments创建POD资源清单</h3><div class="tabs" id="tab1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#tab1-1">Dp资源清单</button></li><li class="tab"><button type="button" data-href="#tab1-2">参数说明</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="tab1-1"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dp-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="string">dp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">paused:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds:</span> <span class="number">600</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">30</span><span class="string">%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">30</span><span class="string">%</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">app</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">nginx-pod</span>]&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tab1-2"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span> <span class="comment"># 版本号</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span> <span class="comment"># 资源类型       </span></span><br><span class="line"><span class="attr">metadata:</span> <span class="comment"># 元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dp-pod</span> <span class="comment"># 名称 </span></span><br><span class="line">  <span class="attr">labels:</span> <span class="comment">#标签</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="string">dp</span></span><br><span class="line"><span class="attr">spec:</span> <span class="comment"># 详情描述</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment"># 副本数量</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">3</span> <span class="comment"># 保留历史版本，默认是10，用于版本回退时使用</span></span><br><span class="line">  <span class="attr">paused:</span> <span class="literal">false</span> <span class="comment"># 暂停部署，默认是false，即Deployment创建好后是否立即开始部署和创建pod</span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds:</span> <span class="number">600</span> <span class="comment"># 部署超时时间（s），默认是600</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="comment"># 策略</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span> <span class="comment"># 滚动更新策略</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span> <span class="comment"># 滚动更新</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">30</span><span class="string">%</span> <span class="comment"># 最大额外可以存在的副本数，可以为百分比，也可以为整数</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">30</span><span class="string">%</span> <span class="comment"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># 选择器，通过它指定该控制器管理哪些pod</span></span><br><span class="line">    <span class="attr">matchLabels:</span>      <span class="comment"># Labels匹配规则</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">matchExpressions:</span> <span class="comment"># Expressions匹配规则</span></span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">app</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">nginx-pod</span>]&#125;</span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span><span class="comment"># 容器</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span><span class="comment"># 容器名称</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.14.0</span><span class="comment"># 镜像名称：镜像版本</span></span><br><span class="line">        <span class="attr">ports:</span><span class="comment"># 声明80端口</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建资源清单命令</span></span><br><span class="line">kubectl apply -f dp.yaml</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221002152121224.png" alt="image-20221002152121224"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看Deployments</span></span><br><span class="line">kubectl get deployments.apps</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221002152349201.png" alt="image-20221002152349201"></p><p>在检查集群中的 Deployment 时，所显示的字段有：</p><ul><li><code>NAME</code> 列出了名字空间中 Deployment 的名称。</li><li><code>READY</code> 显示应用程序的可用的“副本”数。显示的模式是“就绪个数/期望个数”。</li><li><code>UP-TO-DATE</code> 显示为了达到期望状态已经更新的副本数。</li><li><code>AVAILABLE</code> 显示应用可供用户使用的副本数。</li><li><code>AGE</code> 显示应用程序运行的时间。</li></ul><h2 id="ReplicaSet-控制器"><a href="#ReplicaSet-控制器" class="headerlink" title="ReplicaSet 控制器"></a>ReplicaSet 控制器</h2><p><strong>ReplicaSet</strong> 控制器，具体概念请阅读官方文档：<a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/replicaset/">https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/replicaset/</a></p><h3 id="使用ReplicaSet创建POD资源清单"><a href="#使用ReplicaSet创建POD资源清单" class="headerlink" title="使用ReplicaSet创建POD资源清单"></a>使用ReplicaSet创建POD资源清单</h3><div class="tabs" id="tab2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#tab2-1">RS资源清单</button></li><li class="tab"><button type="button" data-href="#tab2-2">参数说明</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="tab2-1"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rs-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="string">rs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">app</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">nginx-pod</span>]&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tab2-2"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span> <span class="comment"># 版本号</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span> <span class="comment"># 资源类型       </span></span><br><span class="line"><span class="attr">metadata:</span> <span class="comment"># 元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rs-pod</span><span class="comment"># rs名称 </span></span><br><span class="line">  <span class="attr">labels:</span> <span class="comment"># 标签</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="string">rs</span><span class="comment"># 键值都是自定义的</span></span><br><span class="line"><span class="attr">spec:</span> <span class="comment"># 详情描述</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment"># 副本数量</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># 选择器，通过它指定该控制器管理哪些pod</span></span><br><span class="line">    <span class="attr">matchLabels:</span>      <span class="comment"># Labels匹配规则</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">matchExpressions:</span> <span class="comment"># Expressions匹配规则</span></span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">app</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">nginx-pod</span>]&#125;</span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span><span class="comment"># 容器</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span><span class="comment"># 容器名称</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.14.0</span><span class="comment"># 镜像名称：镜像版本</span></span><br><span class="line">        <span class="attr">ports:</span><span class="comment"># 声明80端口</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建资源清单命令</span></span><br><span class="line">kubectl apply -f rs-pod.yaml</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221001171425440.png" alt="image-20221001171425440"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过命令动态收缩扩容</span></span><br><span class="line">kubectl scale rs rs-pod --replicas=4</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221001171928296.png" alt="image-20221001171928296"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看RS</span></span><br><span class="line">kubectl get rs</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221002153146306.png" alt="image-20221002153146306"></p><p>ReplicaSet 输出中包含以下字段：</p><ul><li><code>NAME</code> 列出名字空间中 ReplicaSet 的名称；</li><li><code>DESIRED</code> 显示应用的期望副本个数，即在创建 Deployment 时所定义的值。 此为期望状态；</li><li><code>CURRENT</code> 显示当前运行状态中的副本个数；</li><li><code>READY</code> 显示应用中有多少副本可以为用户提供服务；</li><li><code>AGE</code> 显示应用已经运行的时间长度。</li></ul><div class="tip info"><p>ReplicaSet 的替代方案</p><p>Deployment 是一个可以拥有 ReplicaSet 并使用声明式方式在服务器端完成对 Pod 滚动更新的对象。 尽管 ReplicaSet 可以独立使用，目前它们的主要用途是提供给 Deployment 作为编排 Pod 创建、删除和更新的一种机制。当使用 Deployment 时，你不必关心如何管理它所创建的 ReplicaSet，Deployment 拥有并管理其 ReplicaSet。 因此，建议你在需要 ReplicaSet 时使用 Deployment。</p></div><h2 id="DaemonSet-控制器"><a href="#DaemonSet-控制器" class="headerlink" title="DaemonSet 控制器"></a>DaemonSet 控制器</h2><p><strong>DaemonSet</strong> 控制器，具体概念请阅读官方文档：<a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/daemonset/">https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/daemonset/</a></p><h3 id="使用DaemonSet创建POD资源清单"><a href="#使用DaemonSet创建POD资源清单" class="headerlink" title="使用DaemonSet创建POD资源清单"></a>使用DaemonSet创建POD资源清单</h3><div class="tabs" id="tab3"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#tab3-1">DS资源清单</button></li><li class="tab"><button type="button" data-href="#tab3-2">参数说明</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="tab3-1"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span> </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ds</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tab3-2"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span> <span class="comment"># 资源类型</span></span><br><span class="line"><span class="attr">metadata:</span> <span class="comment"># 元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ds</span> <span class="comment"># 资源名称</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="comment"># 标签</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># 自定义标签键值对</span></span><br><span class="line"><span class="attr">spec:</span> <span class="comment"># 详情描述</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># 选择器</span></span><br><span class="line">    <span class="attr">matchLabels:</span> <span class="comment"># Labels匹配规则</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># 模板</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span> </span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span> <span class="comment"># 容器</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span> <span class="comment"># 容器名称</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.14.0</span> <span class="comment"># 镜像名称：镜像版本</span></span><br><span class="line">        <span class="attr">ports:</span> <span class="comment"># 端口</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span> <span class="comment"># 声明80端口</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><div class="tip info"><p>DaemonSet 确保全部（或者某些）节点上运行一个 Pod 的副本</p></div><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221002154122794.png" alt="image-20221002154122794"></p><p>DaemonSet 的一些典型用法：</p><ul><li>在每个节点上运行集群守护进程</li><li>在每个节点上运行日志收集守护进程</li><li><p>在每个节点上运行监控守护进程</p></li><li></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看DS</span></span><br><span class="line">kubectl get ds</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221002155049232.png" alt="image-20221002155049232"></p><p>ReplicaSet 输出中包含以下字段：</p><ul><li><code>NAME</code> 列出名字空间中 ReplicaSet 的名称；</li><li><code>DESIRED</code> 显示应用的期望副本个数，即在创建 Deployment 时所定义的值。 此为期望状态；</li><li><code>CURRENT</code> 显示当前运行状态中的副本个数；</li><li><code>UP-TO-DATE</code> 显示为了达到期望状态已经更新的副本数。</li><li><code>AVAILABLE</code> 显示应用可供用户使用的副本数。</li><li><code>READY</code> 显示应用中有多少副本可以为用户提供服务；</li><li><code>AGE</code> 显示应用已经运行的时间长度。</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes Service 应用</title>
      <link href="/posts/7c78056.html"/>
      <url>/posts/7c78056.html</url>
      
        <content type="html"><![CDATA[<h2 id="Kubernetes-Service-应用"><a href="#Kubernetes-Service-应用" class="headerlink" title="Kubernetes Service 应用"></a>Kubernetes Service 应用</h2><h3 id="ClusterIP资源配置"><a href="#ClusterIP资源配置" class="headerlink" title="ClusterIP资源配置"></a>ClusterIP资源配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span>         <span class="comment"># ClusterIP的端口号</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span>    <span class="comment"># 协议类型</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span>   <span class="comment"># Pod暴露的端口</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span>    <span class="comment"># Service类型</span></span><br></pre></td></tr></table></figure><h3 id="NodePort资源配置"><a href="#NodePort资源配置" class="headerlink" title="NodePort资源配置"></a>NodePort资源配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span>        <span class="comment"># ClusterIP的端口号</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span>     <span class="comment"># 协议类型</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span>    <span class="comment"># Pod暴露的端口</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30000</span>   <span class="comment"># NodeIP的端⼝号，也就是对外⽤户访问的端⼝号</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>      <span class="comment"># Service类型</span></span><br></pre></td></tr></table></figure><h3 id="查看创建的Service资源"><a href="#查看创建的Service资源" class="headerlink" title="查看创建的Service资源"></a>查看创建的Service资源</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes 使用harbor作为私有仓库</title>
      <link href="/posts/4fd95231.html"/>
      <url>/posts/4fd95231.html</url>
      
        <content type="html"><![CDATA[<h2 id="Kubernetes-使用harbor作为私有仓库"><a href="#Kubernetes-使用harbor作为私有仓库" class="headerlink" title="Kubernetes 使用harbor作为私有仓库"></a>Kubernetes 使用harbor作为私有仓库</h2><h3 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h3><p><a href="https://www.opsape.com/posts/64ab9d7e.html">Docker 安装部署</a></p><h3 id="清理以前安装的Harbor"><a href="#清理以前安装的Harbor" class="headerlink" title="清理以前安装的Harbor"></a>清理以前安装的Harbor</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a|grep <span class="string">&quot;goharbor&quot;</span>|awk <span class="string">&#x27;&#123;print &quot;docker stop &quot;$1&#125;&#x27;</span></span><br><span class="line">docker ps -a|grep <span class="string">&quot;goharbor&quot;</span>|awk <span class="string">&#x27;&#123;print &quot;docker rm &quot;$1&#125;&#x27;</span></span><br><span class="line">docker images|grep <span class="string">&quot;goharbor&quot;</span>|awk <span class="string">&#x27;&#123;print &quot;docker rmi &quot;$1&quot;:&quot;$2&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="安装Docker-compose"><a href="#安装Docker-compose" class="headerlink" title="安装Docker-compose"></a>安装Docker-compose</h3><p>github项目地址：<a href="https://github.com/docker/compose/releases/">https://github.com/docker/compose/releases/</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/1.29.2/dockercompose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003194148927.png" alt="image-20221003194148927"></p><h3 id="下载解压并修改harbor配置文件"><a href="#下载解压并修改harbor配置文件" class="headerlink" title="下载解压并修改harbor配置文件"></a>下载解压并修改harbor配置文件</h3><p>github项目地址：<a href="https://github.com/goharbor/harbor/releases">https://github.com/goharbor/harbor/releases</a></p><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003195725029.png" alt="image-20221003195725029"></p><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003195751065.png" alt=""></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar zxf harbor-offline-installer-v1.9.2.tgz -C /opt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置文件</span></span><br><span class="line">vim /opt/harbor/harbor.yml</span><br><span class="line">hostname: 172.16.32.146 <span class="comment"># 修改为node节点IP</span></span><br><span class="line">harbor_admin_password: 123456 <span class="comment"># 登录密码改不改都行</span></span><br></pre></td></tr></table></figure><h3 id="执行安装并访问"><a href="#执行安装并访问" class="headerlink" title="执行安装并访问"></a>执行安装并访问</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/harbor</span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure><div class="tip info"><p><a href="http://172.16.32.146">http://172.16.32.146</a></p></div><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003201453501.png" alt="image-20221003201453501"></p><div class="tip info"><p>用户名：admin，密码：123456</p></div><h3 id="创建一个私有仓库k8s"><a href="#创建一个私有仓库k8s" class="headerlink" title="创建一个私有仓库k8s"></a>创建一个私有仓库k8s</h3><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003201608983.png" alt="image-20221003201608983"></p><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003201637812.png" alt="image-20221003201637812"></p><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003201659452.png" alt="image-20221003201659452"></p><h3 id="配置docker信任仓库并重启"><a href="#配置docker信任仓库并重启" class="headerlink" title="配置docker信任仓库并重启"></a>配置docker信任仓库并重启</h3><div class="tip warning"><p>注意!!!集群服务器都操作!!!</p></div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/etc/docker/daemon.json&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span></span><br><span class="line"><span class="string">  &quot;insecure-registries&quot; : [&quot;http://172.16.32.146&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003202030087.png" alt="image-20221003202030087"></p><div class="tip warning"><p>注意!!!重启docker后harbor会失效，需要重启harbor</p></div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/harbor</span><br><span class="line">docker-compose stop</span><br><span class="line">docker-compose start</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003202527538.png" alt="image-20221003202527538"></p><h3 id="docker登陆harbor"><a href="#docker登陆harbor" class="headerlink" title="docker登陆harbor"></a>docker登陆harbor</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># harbor默认用户名是admin，密码是harbor配置文件设置的密码</span></span><br><span class="line">docker login 172.16.32.146</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003202649339.png" alt="image-20221003202649339"></p><h3 id="将docker登陆凭证转化为k8s能识别的base64编码"><a href="#将docker登陆凭证转化为k8s能识别的base64编码" class="headerlink" title="将docker登陆凭证转化为k8s能识别的base64编码"></a>将docker登陆凭证转化为k8s能识别的base64编码</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker登录后会在家目录生成.docker目录，凭证在该目录内config.json</span></span><br><span class="line"><span class="built_in">cat</span> /root/.docker/config.json|<span class="built_in">base64</span></span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003203054874.png" alt="image-20221003203054874"></p><h3 id="编写Secert资源配置清单"><a href="#编写Secert资源配置清单" class="headerlink" title="编写Secert资源配置清单"></a>编写Secert资源配置清单</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">harbor-secret</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">.dockerconfigjson:</span> <span class="string">ewoJImF1dGhzIjogewoJCSIxNzIuMTYuMzIuMTQ2IjogewoJCQkiYXV0aCI6ICJZV1J0YVc0Nk1USXpORFUyIgoJCX0KCX0KfQ==</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/dockerconfigjson</span></span><br></pre></td></tr></table></figure><h3 id="应用Secret资源"><a href="#应用Secret资源" class="headerlink" title="应用Secret资源"></a>应用Secret资源</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f harbor-secret.yaml</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003203711918.png" alt="image-20221003203711918"></p><h3 id="在harbor仓库修改镜像tag并上传"><a href="#在harbor仓库修改镜像tag并上传" class="headerlink" title="在harbor仓库修改镜像tag并上传"></a>在harbor仓库修改镜像tag并上传</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx:latest</span><br><span class="line">docker tag nginx:latest 172.16.32.146/k8s/nginx:latest</span><br><span class="line">docker push 172.16.32.146/k8s/nginx:latest</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003204110523.png" alt="image-20221003204110523"></p><h3 id="编写资源清单测试"><a href="#编写资源清单测试" class="headerlink" title="编写资源清单测试"></a>编写资源清单测试</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span>  <span class="comment"># 镜像拉取策略</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">harbor-secret</span> <span class="comment"># 填写密钥资源名称</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line">    <span class="attr">image:</span> <span class="number">172.16</span><span class="number">.32</span><span class="number">.146</span><span class="string">/k8s/nginx:latest</span> <span class="comment"># 镜像地址写harbor仓库地址</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h3 id="应用资源清单并查看"><a href="#应用资源清单并查看" class="headerlink" title="应用资源清单并查看"></a>应用资源清单并查看</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nginx-harbor.yaml</span><br><span class="line">kubectl get pod</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003204624903.png" alt="image-20221003204624903"></p><div class="tip warning"><p>Secert资源需要和拉取镜像的Pod属于同一个命名空间</p></div>]]></content>
      
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes 的全功能Web界面-Dashboard</title>
      <link href="/posts/76f3841d.html"/>
      <url>/posts/76f3841d.html</url>
      
        <content type="html"><![CDATA[<h2 id="Kubernetes-的全功能Web界面-Dashboard"><a href="#Kubernetes-的全功能Web界面-Dashboard" class="headerlink" title="Kubernetes 的全功能Web界面-Dashboard"></a>Kubernetes 的全功能Web界面-Dashboard</h2><p>Dashboard具体概念，请阅读官方文档：<a href="https://kubernetes.io/zh-cn/blog/2016/07/15/dashboard-web-interface-for-kubernetes/">https://kubernetes.io/zh-cn/blog/2016/07/15/dashboard-web-interface-for-kubernetes/</a></p><h3 id="安装部署Dashboard"><a href="#安装部署Dashboard" class="headerlink" title="安装部署Dashboard"></a>安装部署Dashboard</h3><h4 id="官方项目地址"><a href="#官方项目地址" class="headerlink" title="官方项目地址"></a>官方项目地址</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/kubernetes/dashboard</span><br></pre></td></tr></table></figure><h4 id="下载配置文件并应用"><a href="#下载配置文件并应用" class="headerlink" title="下载配置文件并应用"></a>下载配置文件并应用</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.4/aio/deploy/recommended.yaml</span><br><span class="line"><span class="comment"># 下载无效请到项目地址手动下载</span></span><br><span class="line">https://github.com/kubernetes/dashboard/releases?page=2</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003180738875.png" alt="image-20221003180738875"></p><h4 id="应用资源配置"><a href="#应用资源配置" class="headerlink" title="应用资源配置"></a>应用资源配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f recommended.yaml</span><br></pre></td></tr></table></figure><h4 id="查看创建的Pod"><a href="#查看创建的Pod" class="headerlink" title="查看创建的Pod"></a>查看创建的Pod</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubernetes-dashboard get pods</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003180901120.png" alt="image-20221003180901120"></p><h3 id="安装部署Metrics-Scraper"><a href="#安装部署Metrics-Scraper" class="headerlink" title="安装部署Metrics Scraper"></a>安装部署Metrics Scraper</h3><p>请阅读&gt;&gt;<a href="https://www.opsape.com/posts/c3d3ccc.html">Kubernetes HPA监控</a></p><h3 id="创建Ingress资源并应用"><a href="#创建Ingress资源并应用" class="headerlink" title="创建Ingress资源并应用"></a>创建Ingress资源并应用</h3><h4 id="创建资源配置"><a href="#创建资源配置" class="headerlink" title="创建资源配置"></a>创建资源配置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">    <span class="attr">ingress.kubernetes.io/ssl-passthrough:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/backend-protocol:</span> <span class="string">&quot;HTTPS&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">&quot;dashboard.k8s.com&quot;</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">443</span></span><br></pre></td></tr></table></figure><h4 id="应用配置"><a href="#应用配置" class="headerlink" title="应用配置"></a>应用配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f dashboard-ingress.yaml</span><br></pre></td></tr></table></figure><h4 id="关键参数解释"><a href="#关键参数解释" class="headerlink" title="关键参数解释"></a>关键参数解释</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span> <span class="comment"># 注解</span></span><br><span class="line">  <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span> <span class="comment"># 使用的是nginx类型的ingress</span></span><br><span class="line">  <span class="attr">ingress.kubernetes.io/ssl-passthrough:</span> <span class="string">&quot;true&quot;</span> <span class="comment">#S SL透传</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/backend-protocol:</span> <span class="string">&quot;HTTPS&quot;</span> <span class="comment"># 后端使用TLS协议</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span> <span class="comment"># URL重定向</span></span><br></pre></td></tr></table></figure><h3 id="访问网页测试"><a href="#访问网页测试" class="headerlink" title="访问网页测试"></a>访问网页测试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在windows、mac本地hosts配置域名解析</span></span><br><span class="line">172.16.32.145 dashboard.k8s.com</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003182118144.png" alt="image-20221003182118144"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用https协议访问dashboard.k8s.com</span></span><br><span class="line">https://dashboard.k8s.com</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003182224802.png" alt="image-20221003182224802"></p><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003182246714.png" alt="image-20221003182246714"></p><h3 id="创建管理员账户并应用"><a href="#创建管理员账户并应用" class="headerlink" title="创建管理员账户并应用"></a>创建管理员账户并应用</h3><h4 id="创建授权资源配置清单"><a href="#创建授权资源配置清单" class="headerlink" title="创建授权资源配置清单"></a>创建授权资源配置清单</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure><h4 id="应用资源配置清单"><a href="#应用资源配置清单" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">dashboard-admin.yaml</span></span><br></pre></td></tr></table></figure><h3 id="查看资源并获取token"><a href="#查看资源并获取token" class="headerlink" title="查看资源并获取token"></a>查看资源并获取token</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看dashboard相关资源</span></span><br><span class="line">kubectl get pod -n kubernetes-dashboard -o wide</span><br><span class="line">kubectl get svc -n kubernetes-dashboard</span><br><span class="line">kubectl get secret -n kubernetes-dashboard</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003183319525.png" alt="image-20221003183319525"></p><h3 id="复制Token到浏览器登录"><a href="#复制Token到浏览器登录" class="headerlink" title="复制Token到浏览器登录"></a>复制Token到浏览器登录</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取管理员凭证</span></span><br><span class="line">kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)|grep <span class="string">&quot;token:&quot;</span>|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003183353937.png" alt="image-20221003183353937"></p><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003183712019.png" alt="image-20221003183712019"></p><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221003183801276.png" alt="image-20221003183801276"></p>]]></content>
      
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes持久卷、存储卷的PV、PVC创建应用</title>
      <link href="/posts/6e8ce213.html"/>
      <url>/posts/6e8ce213.html</url>
      
        <content type="html"><![CDATA[<p>Kubernetes 中的<strong>持久卷（Persistent Volume）</strong> 具体概念请阅读官方文档：<a href="https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/">https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/</a></p><h2 id="创建hostPath类型的PV和PVC"><a href="#创建hostPath类型的PV和PVC" class="headerlink" title="创建hostPath类型的PV和PVC"></a>创建hostPath类型的PV和PVC</h2><h3 id="创建PV"><a href="#创建PV" class="headerlink" title="创建PV"></a>创建PV</h3><div class="tabs" id="tab1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#tab1-1">PV资源清单</button></li><li class="tab"><button type="button" data-href="#tab1-2">参数说明</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="tab1-1"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv-ssd-name</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">pv-ssd</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span>  </span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;/ssd&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tab1-2"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span><span class="comment">#PV资源类型</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv-ssd-name</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">pv-ssd</span><span class="comment">#定义一个storageClass资源对象的名称</span></span><br><span class="line">  <span class="attr">capacity:</span><span class="comment"># 存储容量</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span><span class="comment">#定义PV的存储容量大小</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span><span class="comment"># 存储卷模式</span></span><br><span class="line"><span class="comment"># 针对 PV 持久卷，Kubernetes 支持两种卷模式（volumeModes）：Filesystem（文件系统） 和 Block（块）。如果该参数被省略，默认的卷模式是 Filesystem。</span></span><br><span class="line">  <span class="attr">accessModes:</span><span class="comment"># 访问模式</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="comment"># Kubernetes 支持的访问模式如下</span></span><br><span class="line"><span class="comment"># - ReadWriteOnce(RWO): 读写权限，并且只能被单个Node挂载 </span></span><br><span class="line"><span class="comment">#- ReadOnlyMany(ROX): 只读权限，允许被多个Node挂载 </span></span><br><span class="line"><span class="comment"># - ReadWriteMany(RWX): 读写权限，允许被多个Node挂载</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span> <span class="comment"># 回收策略</span></span><br><span class="line"><span class="comment"># - Retain: 保留数据，需要⼿⼯处理</span></span><br><span class="line"><span class="comment"># - Recycle: 简单清除⽂件的操作(例如运⾏rm -rf /dada/* 命令)</span></span><br><span class="line"><span class="comment"># - Delete: 与PV相连的后端存储完成Volume的删除操作</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;/ssd&quot;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="创建PVC"><a href="#创建PVC" class="headerlink" title="创建PVC"></a>创建PVC</h3><div class="tabs" id="tab2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#tab2-1">PVC资源清单</button></li><li class="tab"><button type="button" data-href="#tab2-2">参数说明</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="tab2-1"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc-ssd-name</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">pv-ssd</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">5Gi</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tab2-2"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span><span class="comment">#PVC资源类型</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc-ssd-name</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">pv-ssd</span><span class="comment"># 绑定storageClass资源对象的名称</span></span><br><span class="line">  <span class="attr">accessModes:</span><span class="comment"># 访问模式要跟绑定的PV定义一致</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span><span class="comment"># 描述对存储资源的请求，设置需要的存储空间⼤⼩</span></span><br><span class="line">    <span class="attr">requests:</span><span class="comment"># 申请5Gi存储空间</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">5Gi</span> <span class="comment"># 必须小于等于PV定义的存储空间</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="创建资源并查看资源状态"><a href="#创建资源并查看资源状态" class="headerlink" title="创建资源并查看资源状态"></a>创建资源并查看资源状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f pv.yaml</span><br><span class="line">kubectl apply -f pv.yaml</span><br><span class="line">kubectl get pv</span><br><span class="line">kubectl get pvc</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221001141443164.png" alt="image-20221001141443164"></p><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221001143229657.png" alt="image-20221001143229657"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line">NAME<span class="comment">#PV/PVC名称</span></span><br><span class="line">CAPACITY<span class="comment"># 存储容量大小</span></span><br><span class="line">ACCESS MODES<span class="comment">#访问模式</span></span><br><span class="line">RECLAIM POLICY<span class="comment"># 回收策略</span></span><br><span class="line">STATUS</span><br><span class="line"><span class="comment"># Avaliable（可⽤）：表示可⽤状态，还未被任何PVC绑定</span></span><br><span class="line"><span class="comment"># Bound（可绑定）：表示PV已经被PVC绑定</span></span><br><span class="line"><span class="comment"># Released（已释放）：PVC被删除，但是资源还未被集群重新声明</span></span><br><span class="line"><span class="comment"># Failed（失败）：表示该PV的⾃动回收失败</span></span><br><span class="line">VOLUME <span class="comment"># 绑定的PV名称</span></span><br><span class="line">CLAIM<span class="comment">#绑定的PVC名称</span></span><br><span class="line">STORAGECLASS<span class="comment"># 类名称</span></span><br><span class="line">REASON<span class="comment"># 原因</span></span><br><span class="line">AGE<span class="comment">#创建多久的时间</span></span><br></pre></td></tr></table></figure><div class="tip success"><p>通过查看pvc状态可以看到STATUS字段显示的状态为Bound，这⾥表示PVC已经与PV进⾏了绑定</p></div><h3 id="创建POD"><a href="#创建POD" class="headerlink" title="创建POD"></a>创建POD</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-name</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volumes-name</span> </span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">pvc-ssd-name</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">node1</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-name</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volumes-name</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/usr/share/nginx/html&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用参数说明</span></span><br><span class="line">    persistentVolumeClaim:<span class="comment"># PVC类型</span></span><br><span class="line">      claimName: pvc-ssd-name <span class="comment"># Pod绑定PVC名称</span></span><br><span class="line">      </span><br><span class="line"><span class="comment"># 创建POD资源</span></span><br><span class="line">kubectl apply -f pod.yaml</span><br></pre></td></tr></table></figure><h3 id="测试挂载情况"><a href="#测试挂载情况" class="headerlink" title="测试挂载情况"></a>测试挂载情况</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it pod-name -- /bin/bash</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221001162547455.png" alt="image-20221001162547455"></p><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221001162650107.png" alt="image-20221001162650107"></p><hr><p>Kubernetes 中的<strong>存储类</strong> 具体概念请阅读官方文档：<a href="https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/">https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/</a></p><h2 id="创建NFS类型PV和PVC"><a href="#创建NFS类型PV和PVC" class="headerlink" title="创建NFS类型PV和PVC"></a>创建NFS类型PV和PVC</h2><h3 id="nfs配置"><a href="#nfs配置" class="headerlink" title="nfs配置"></a>nfs配置</h3><div class="tip warning"><p>注意：Node节点也需要安装nfs客户端</p></div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum install nfs-utils -y</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/exports &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">/data/k8s/nfs 172.16.32.0/8(rw,sync,no_root_squash)</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">systemctl restart nfs rpcbind</span><br><span class="line"><span class="built_in">mkdir</span> -p /data/k8s/nfs</span><br><span class="line"><span class="built_in">chown</span> -R nfsnobody:nfsnobody /data/k8s/nfs/</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nfs master ok&quot;</span> &gt;&gt; /data/k8s/nfs/index.html</span><br></pre></td></tr></table></figure><h3 id="创建PV-1"><a href="#创建PV-1" class="headerlink" title="创建PV"></a>创建PV</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv-nfs</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">172.16</span><span class="number">.32</span><span class="number">.144</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/k8s/nfs</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建PV资源</span></span><br><span class="line">kubectl apply -f pv-nfs.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用参数说明</span></span><br><span class="line">nfs: <span class="comment"># 存储类型是NFS</span></span><br><span class="line">  server: 172.16.32.144 <span class="comment"># NFS服务的IP地址</span></span><br><span class="line">  path: /data/nfs-volume/mysql <span class="comment"># NFS的共享⽬录路径</span></span><br></pre></td></tr></table></figure><h3 id="创建PVC-1"><a href="#创建PVC-1" class="headerlink" title="创建PVC"></a>创建PVC</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc-nfs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建PVC资源</span></span><br><span class="line">kubectl apply -f pvc-nfs.yaml</span><br></pre></td></tr></table></figure><h3 id="创建POD使用PVC"><a href="#创建POD使用PVC" class="headerlink" title="创建POD使用PVC"></a>创建POD使用PVC</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-pvc-nfs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pvc-nfs</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">pvc-nfs</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-pvc-nfs</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pvc-nfs</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/usr/share/nginx/html&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建POD资源</span></span><br><span class="line">kubectl apply -f pod-pvc-nfs.yaml</span><br></pre></td></tr></table></figure><h3 id="测试访问"><a href="#测试访问" class="headerlink" title="测试访问"></a>测试访问</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># curl 10.2.2.2</span></span><br><span class="line">nfs master ok</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221001153038060.png" alt="image-20221001153038060"></p>]]></content>
      
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用kubeadm部署kubernetes教程</title>
      <link href="/posts/4f2bf8b1.html"/>
      <url>/posts/4f2bf8b1.html</url>
      
        <content type="html"><![CDATA[<p>kubeadm：<a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></p><h2 id="kubeadm部署前规划"><a href="#kubeadm部署前规划" class="headerlink" title="kubeadm部署前规划"></a>kubeadm部署前规划</h2><h3 id="节点组件规划"><a href="#节点组件规划" class="headerlink" title="节点组件规划"></a>节点组件规划</h3><div class="table-container"><table><thead><tr><th>名称</th><th>宿主机IP</th><th>节点服务</th></tr></thead><tbody><tr><td>master</td><td>172.16.32.144</td><td>API Server,controlle,scheduler,kube-proxy,kubelet,etcd</td></tr><tr><td>node1</td><td>172.16.32.145</td><td>Dokcer kubelet kube-proxy</td></tr><tr><td>node2</td><td>172.16.32.146</td><td>Dokcer kubelet kube-proxy</td></tr></tbody></table></div><h3 id="IP规划"><a href="#IP规划" class="headerlink" title="IP规划"></a><strong>IP规划</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Node IP     10.0.0.0</span><br><span class="line">Cluster IP  10.1.0.0</span><br><span class="line">POD IP      10.2.0.0</span><br></pre></td></tr></table></figure><h2 id="宿主机准备环境"><a href="#宿主机准备环境" class="headerlink" title="宿主机准备环境"></a>宿主机准备环境</h2><h3 id="所有节点配置host解析"><a href="#所有节点配置host解析" class="headerlink" title="所有节点配置host解析"></a>所有节点配置host解析</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/hosts &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">172.16.32.144   master</span></span><br><span class="line"><span class="string">172.16.32.145   node1</span></span><br><span class="line"><span class="string">172.16.32.146   node2</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h3 id="所有节点关闭防火墙"><a href="#所有节点关闭防火墙" class="headerlink" title="所有节点关闭防火墙"></a>所有节点关闭防火墙</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl  stop  firewalld   NetworkManager </span><br><span class="line">systemctl  <span class="built_in">disable</span>  firewalld   NetworkManager</span><br></pre></td></tr></table></figure><h3 id="所有节点关闭SELinux"><a href="#所有节点关闭SELinux" class="headerlink" title="所有节点关闭SELinux"></a>所有节点关闭SELinux</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">&#x27;s#SELINUX=disabled#SELINUX=disabled#g&#x27;</span> /etc/selinux/config</span><br><span class="line">getenforce</span><br></pre></td></tr></table></figure><h3 id="所有节点更新清华源"><a href="#所有节点更新清华源" class="headerlink" title="所有节点更新清华源"></a>所有节点更新清华源</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/yum.repos.d/CentOS-Base.repo &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[base]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Base - mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.tuna.tsinghua.edu.cn/centos/<span class="variable">$releasever</span>/os/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.tuna.tsinghua.edu.cn/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"> </span><br><span class="line"><span class="comment">#released updates </span></span><br><span class="line">[updates]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Updates - mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.tuna.tsinghua.edu.cn/centos/<span class="variable">$releasever</span>/updates/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.tuna.tsinghua.edu.cn/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"> </span><br><span class="line"><span class="comment">#additional packages that may be useful</span></span><br><span class="line">[extras]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Extras - mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.tuna.tsinghua.edu.cn/centos/<span class="variable">$releasever</span>/extras/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.tuna.tsinghua.edu.cn/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"> </span><br><span class="line"><span class="comment">#additional packages that extend functionality of existing packages</span></span><br><span class="line">[centosplus]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Plus - mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.tuna.tsinghua.edu.cn/centos/<span class="variable">$releasever</span>/centosplus/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=http://mirrors.tuna.tsinghua.edu.cn/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"> </span><br><span class="line"><span class="comment">#contrib - packages by Centos Users</span></span><br><span class="line">[contrib]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Contrib - mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.tuna.tsinghua.edu.cn/centos/<span class="variable">$releasever</span>/contrib/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=http://mirrors.tuna.tsinghua.edu.cn/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/yum.repos.d/epel.repo &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[epel]</span><br><span class="line">name=Extra Packages <span class="keyword">for</span> Enterprise Linux 7 - <span class="variable">$basearch</span></span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/<span class="variable">$basearch</span></span><br><span class="line"><span class="comment">#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-7&amp;arch=$basearch</span></span><br><span class="line">failovermethod=priority</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache fast</span><br></pre></td></tr></table></figure><h3 id="所有节点确保网络通畅"><a href="#所有节点确保网络通畅" class="headerlink" title="所有节点确保网络通畅"></a>所有节点确保网络通畅</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ping -c 1 www.baidu.com</span><br><span class="line">ping -c 1 master</span><br><span class="line">ping -c 1 node1</span><br><span class="line">ping -c 1 node2</span><br></pre></td></tr></table></figure><h3 id="所有节点配置时间同步"><a href="#所有节点配置时间同步" class="headerlink" title="所有节点配置时间同步"></a>所有节点配置时间同步</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install chrony -y</span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl <span class="built_in">enable</span> chronyd</span><br><span class="line"><span class="built_in">date</span></span><br></pre></td></tr></table></figure><h3 id="所有节点关闭SWAP分区"><a href="#所有节点关闭SWAP分区" class="headerlink" title="所有节点关闭SWAP分区"></a>所有节点关闭SWAP分区</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;/swap/d&#x27;</span> /etc/fstab</span><br><span class="line">free -h</span><br></pre></td></tr></table></figure><h2 id="kubeadm准备环境"><a href="#kubeadm准备环境" class="headerlink" title="kubeadm准备环境"></a>kubeadm准备环境</h2><h3 id="所有节点设置k8s禁止使用swap"><a href="#所有节点设置k8s禁止使用swap" class="headerlink" title="所有节点设置k8s禁止使用swap"></a>所有节点设置k8s禁止使用swap</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/sysconfig/kubelet&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">KUBELET_CGROUP_ARGS=&quot;--cgroup-driver=systemd&quot;</span></span><br><span class="line"><span class="string">KUBELET_EXTRA_ARGS=&quot;--fail-swap-on=false&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h3 id="所有节点设置内核参数"><a href="#所有节点设置内核参数" class="headerlink" title="所有节点设置内核参数"></a>所有节点设置内核参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;  /etc/sysctl.d/k8s.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure><h3 id="所有节点加载IPVS模块"><a href="#所有节点加载IPVS模块" class="headerlink" title="所有节点加载IPVS模块"></a>所有节点加载IPVS模块</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/etc/sysconfig/modules/ipvs.modules&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">modprobe -- ip_vs</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_rr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_wrr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_sh</span></span><br><span class="line"><span class="string">modprobe -- nf_conntrack_ipv4</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">chmod</span> +x /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"><span class="built_in">source</span> /etc/sysconfig/modules/ipvs.modules</span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack_ipv</span><br></pre></td></tr></table></figure><h3 id="所有节点安装配置Docker"><a href="#所有节点安装配置Docker" class="headerlink" title="所有节点安装配置Docker"></a>所有节点安装配置Docker</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.docker.com/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">sed -i <span class="string">&#x27;s#download.docker.com#mirrors.tuna.tsinghua.edu.cn/docker-ce#&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">yum makecache fast</span><br><span class="line">yum -y install docker-ce-20.10.15 docker-ce-cli-20.10.15</span><br><span class="line"><span class="built_in">mkdir</span> /etc/docker -p</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker &amp;&amp; systemctl start docker</span><br><span class="line">docker -v</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="所有节点设置kubeadm的国内yum仓库-清华源"><a href="#所有节点设置kubeadm的国内yum仓库-清华源" class="headerlink" title="所有节点设置kubeadm的国内yum仓库-清华源"></a>所有节点设置kubeadm的国内yum仓库-清华源</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/etc/yum.repos.d/kubernetes.repo&lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[kubernetes]</span><br><span class="line">name=kubernetes</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/kubernetes/yum/repos/kubernetes-el7-<span class="variable">$basearch</span></span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="所有节点安装kubeadm"><a href="#所有节点安装kubeadm" class="headerlink" title="所有节点安装kubeadm"></a>所有节点安装kubeadm</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubelet-1.20.15 kubeadm-1.20.15 kubectl-1.20.15 ipvsadm --nogpgcheck</span><br></pre></td></tr></table></figure><h3 id="设置kubelet开机启动"><a href="#设置kubelet开机启动" class="headerlink" title="设置kubelet开机启动"></a>设置kubelet开机启动</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br></pre></td></tr></table></figure><h2 id="kubeadm-master节点配置"><a href="#kubeadm-master节点配置" class="headerlink" title="kubeadm master节点配置"></a>kubeadm master节点配置</h2><h3 id="master节点初始化集群"><a href="#master节点初始化集群" class="headerlink" title="master节点初始化集群"></a>master节点初始化集群</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init \</span><br><span class="line">--apiserver-advertise-address=172.16.32.144 \</span><br><span class="line">--image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">--kubernetes-version v1.20.15 \</span><br><span class="line">--service-cidr=10.1.0.0/16 \</span><br><span class="line">--pod-network-cidr=10.2.0.0/16 \</span><br><span class="line">--service-dns-domain=cluster.local \</span><br><span class="line">--ignore-preflight-errors=Swap \</span><br><span class="line">--ignore-preflight-errors=NumCPU</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20220929194028463.png" alt="image-20220929194028463"></p><div class="tip bell"><p>kubeadm初始化完成后，请保存一下最后两行node节点加入集群命令，后续用到</p></div><h3 id="master节点执行配置命令"><a href="#master节点执行配置命令" class="headerlink" title="master节点执行配置命令"></a>master节点执行配置命令</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line"><span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><h3 id="master节点获取node节点信息"><a href="#master节点获取node节点信息" class="headerlink" title="master节点获取node节点信息"></a>master节点获取node节点信息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20220929194108718.png" alt="image-20220929194108718"></p><h3 id="master节点设置kube-proxy使用ipvs模式"><a href="#master节点设置kube-proxy使用ipvs模式" class="headerlink" title="master节点设置kube-proxy使用ipvs模式"></a>master节点设置kube-proxy使用ipvs模式</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit cm kube-proxy -n kube-system</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20220929194240858.png" alt="image-20220929194240858"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod|grep kube-proxy|awk <span class="string">&#x27;&#123;print &quot;kubectl -n kube-system delete pod &quot;$1&#125;&#x27;</span>|bash</span><br><span class="line">ipvsadm -Ln</span><br></pre></td></tr></table></figure><div class="tip info"><p>此处是删除原来kube-proxy，生成新的kube-proxy，执行命令显示下面一样即可</p></div><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20220929200848275.png" alt="image-20220929200848275"></p><h3 id="master节点部署Flannel网络插件"><a href="#master节点部署Flannel网络插件" class="headerlink" title="master节点部署Flannel网络插件"></a>master节点部署Flannel网络插件</h3><p>Flannel：<a href="https://github.com/flannel-io/flannel/blob/master/Documentation/kube-flannel.yml">https://github.com/flannel-io/flannel/blob/master/Documentation/kube-flannel.yml</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">pod-security.kubernetes.io/enforce:</span> <span class="string">privileged</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">cni-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &quot;cbr0&quot;,</span></span><br><span class="line"><span class="string">      &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;plugins&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;flannel&quot;,</span></span><br><span class="line"><span class="string">          &quot;delegate&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;hairpinMode&quot;: true,</span></span><br><span class="line"><span class="string">            &quot;isDefaultGateway&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;portmap&quot;,</span></span><br><span class="line"><span class="string">          &quot;capabilities&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;portMappings&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">net-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;Network&quot;: &quot;10.2.0.0/16&quot;,</span></span><br><span class="line"><span class="string">      &quot;Backend&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;Type&quot;: &quot;vxlan&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-ds</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/os</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">flannel</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni-plugin</span></span><br><span class="line">       <span class="comment">#image: flannelcni/flannel-cni-plugin:v1.1.0 for ppc64le and mips64le (dockerhub limitations may apply)</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin:v1.1.0</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/flannel</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/cni/bin/flannel</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni-plugin</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/opt/cni/bin</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni</span></span><br><span class="line">       <span class="comment">#image: flannelcni/flannel:v0.19.2 for ppc64le and mips64le (dockerhub limitations may apply)</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/rancher/mirrored-flannelcni-flannel:v0.19.2</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/kube-flannel/cni-conf.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/cni/net.d/10-flannel.conflist</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line">       <span class="comment">#image: flannelcni/flannel:v0.19.2 for ppc64le and mips64le (dockerhub limitations may apply)</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/rancher/mirrored-flannelcni-flannel:v0.19.2</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/bin/flanneld</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--ip-masq</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kube-subnet-mgr</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--iface=ens33</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;50Mi&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;50Mi&quot;</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">add:</span> [<span class="string">&quot;NET_ADMIN&quot;</span>, <span class="string">&quot;NET_RAW&quot;</span>]</span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">EVENT_QUEUE_DEPTH</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;5000&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run/flannel</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xtables-lock</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/run/flannel</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni-plugin</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/opt/cni/bin</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xtables-lock</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">FileOrCreate</span></span><br></pre></td></tr></table></figure><div class="tip bell"><p>在84行修改Networkip，规划时是10.2.0.0/16 。 在159行增加网卡类型“- —iface=ens33”，自行查看宿主机时eth0还是ens33</p></div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml</span><br><span class="line">kubectl -n kube-system get pod</span><br><span class="line">kubectl -n kube-system get nodes</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20220929200004568.png" alt="image-20220929200004568"></p><div class="tip info"><p>flannel apply后需要等待，所有pod都Running即可</p></div><h2 id="kubeadm-node节点配置"><a href="#kubeadm-node节点配置" class="headerlink" title="kubeadm node节点配置"></a>kubeadm node节点配置</h2><h3 id="node节点加入集群"><a href="#node节点加入集群" class="headerlink" title="node节点加入集群"></a>node节点加入集群</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> 172.16.32.144:6443 --token 55vl92.0h5vgdupwcnyl4dj \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:f30947828a174c35ad12fcc2b635b4f9d5bb7c6bc1ef5c44ccb0ced5430d607e</span><br></pre></td></tr></table></figure><h3 id="master节点执行打标签命令"><a href="#master节点执行打标签命令" class="headerlink" title="master节点执行打标签命令"></a>master节点执行打标签命令</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes node1 node-role.kubernetes.io/node=</span><br><span class="line">kubectl label nodes node2 node-role.kubernetes.io/node=</span><br></pre></td></tr></table></figure><h3 id="检查状态"><a href="#检查状态" class="headerlink" title="检查状态"></a>检查状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20220929200552879.png" alt="image-20220929200552879"></p><div class="tip info"><p>node节点加入集群等待所有状态都Ready即可</p></div><h2 id="kubectl支持命令补全"><a href="#kubectl支持命令补全" class="headerlink" title="kubectl支持命令补全"></a>kubectl支持命令补全</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install bash-completion -y</span><br><span class="line"><span class="built_in">source</span> /usr/share/bash-completion/bash_completion</span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line">kubectl completion bash &gt; /etc/bash_completion.d/kubectl</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes HPA监控</title>
      <link href="/posts/c3d3ccc.html"/>
      <url>/posts/c3d3ccc.html</url>
      
        <content type="html"><![CDATA[<h2 id="Kubernetes-HPA监控"><a href="#Kubernetes-HPA监控" class="headerlink" title="Kubernetes HPA监控"></a>Kubernetes HPA监控</h2><h3 id="HPA介绍"><a href="#HPA介绍" class="headerlink" title="HPA介绍"></a>HPA介绍</h3><p>HAP通过收集来的监控指标分析所有Pod的负载情况，并且根据我们设定好的标准来自动扩容收缩ReplicationController、 Deployment、ReplicaSet 或 StatefulSet 中的 Pod 数量。</p><h3 id="Metrics-Server介绍"><a href="#Metrics-Server介绍" class="headerlink" title="Metrics Server介绍"></a>Metrics Server介绍</h3><p>在HAP早期版本使⽤的是⼀个叫Heapster组件来提供CPU和内存指标的，在后期的版本k8s转向了使⽤MetrcisServer组件来提供Pod的CPU和内存指标，Metrcis Server通过Metrics API将数据暴露出来，然后我们就可以使⽤k8s的API来获取相应的数据。</p><h3 id="Metrics-Server安装"><a href="#Metrics-Server安装" class="headerlink" title="Metrics Server安装"></a>Metrics Server安装</h3><h4 id="下载components-yaml"><a href="#下载components-yaml" class="headerlink" title="下载components.yaml"></a>下载components.yaml</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/kubernetes-sigs/metricsserver/releases/download/v0.4.0/components.yaml</span><br></pre></td></tr></table></figure><p>如果下载不了，访问github的项目地址手动下载：<a href="https://github.com/kubernetes-sigs/metrics-server/releases?page=2">https://github.com/kubernetes-sigs/metrics-server/releases?page=2</a></p><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221002181507321.png" alt="image-20221002181507321"></p><h4 id="各节点下载Metrics-Server"><a href="#各节点下载Metrics-Server" class="headerlink" title="各节点下载Metrics Server"></a>各节点下载Metrics Server</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull ccr.ccs.tencentyun.com/mirrors/metrics-server:v0.4.0</span><br></pre></td></tr></table></figure><h4 id="修改components-yaml"><a href="#修改components-yaml" class="headerlink" title="修改components.yaml"></a>修改components.yaml</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">设置跳过证书检查：- --kubelet-insecure-tls</span><br><span class="line">修改为腾讯云镜像：ccr.ccs.tencentyun.com/mirrors/metrics-server:v0.4.0</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221002175645836.png" alt="image-20221002175645836"></p><h4 id="创建资源"><a href="#创建资源" class="headerlink" title="创建资源"></a>创建资源</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f components.yaml</span><br></pre></td></tr></table></figure><h4 id="查看node监控信息"><a href="#查看node监控信息" class="headerlink" title="查看node监控信息"></a>查看node监控信息</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl top nodes</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221002175852424.png" alt="image-20221002175852424"></p><h4 id="查看Pod监控信息"><a href="#查看Pod监控信息" class="headerlink" title="查看Pod监控信息"></a>查看Pod监控信息</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system top pod</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221002182145979.png" alt="image-20221002182145979"></p><h3 id="生成测试镜像"><a href="#生成测试镜像" class="headerlink" title="生成测试镜像"></a>生成测试镜像</h3><h4 id="创建测试首页"><a href="#创建测试首页" class="headerlink" title="创建测试首页"></a>创建测试首页</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; index.php &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&lt;?php</span><br><span class="line">  <span class="variable">$x</span> = 0.0001;</span><br><span class="line">  <span class="keyword">for</span> (<span class="variable">$i</span> = 0; <span class="variable">$i</span> &lt;= 1000000; <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="variable">$x</span> += sqrt(<span class="variable">$x</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;OK!&quot;</span>;</span><br><span class="line">?&gt;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="创建dokerfile"><a href="#创建dokerfile" class="headerlink" title="创建dokerfile"></a>创建dokerfile</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; dockerfile &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">FROM php:5-apache</span><br><span class="line">ADD index.php /var/www/html/index.php</span><br><span class="line">RUN <span class="built_in">chmod</span> a+rx index.php</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="生成镜像"><a href="#生成镜像" class="headerlink" title="生成镜像"></a>生成镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t php:v1 .</span><br></pre></td></tr></table></figure><h4 id="将镜像导出发送到其它节点"><a href="#将镜像导出发送到其它节点" class="headerlink" title="将镜像导出发送到其它节点"></a>将镜像导出发送到其它节点</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker save php:v1 &gt; php.tar</span><br><span class="line">scp php.tar 172.16.32.145:/root/</span><br><span class="line">scp php.tar 172.16.32.146:/root/</span><br></pre></td></tr></table></figure><h4 id="其它节点导入镜像"><a href="#其它节点导入镜像" class="headerlink" title="其它节点导入镜像"></a>其它节点导入镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load &lt; /root/php.tar</span><br></pre></td></tr></table></figure><h4 id="创建Deployment资源"><a href="#创建Deployment资源" class="headerlink" title="创建Deployment资源"></a>创建Deployment资源</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">php-apache</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">php:v1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">200m</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f php-dp.yaml</span><br></pre></td></tr></table></figure><h4 id="创建HPA资源"><a href="#创建HPA资源" class="headerlink" title="创建HPA资源"></a>创建HPA资源</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">targetCPUUtilizationPercentage:</span> <span class="number">50</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f php-hpa.yaml</span><br></pre></td></tr></table></figure><h4 id="查看HPA扩所容情况"><a href="#查看HPA扩所容情况" class="headerlink" title="查看HPA扩所容情况"></a>查看HPA扩所容情况</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get hpa -w</span><br><span class="line">kubectl get pod -w</span><br></pre></td></tr></table></figure><h4 id="创建Service资源并访问进行压测"><a href="#创建Service资源并访问进行压测" class="headerlink" title="创建Service资源并访问进行压测"></a>创建Service资源并访问进行压测</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">php-apache</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">php-apache</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f hpa-svc.yaml</span><br></pre></td></tr></table></figure><p><img src="https://typora-1257900361.cos.ap-guangzhou.myqcloud.com/images/image-20221002231104513.png" alt="image-20221002231104513"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">while true; do wget -q -O- http://10.1.217.203; done</span><br></pre></td></tr></table></figure><div class="tip info"><p>如果CPU使⽤率降下来了,k8s在5分钟左右后进⾏收缩</p></div>]]></content>
      
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 将 Git 更新至最新版本（yum）</title>
      <link href="/posts/e5c226cc.html"/>
      <url>/posts/e5c226cc.html</url>
      
        <content type="html"><![CDATA[<h2 id="Linux-将-Git-更新至最新版本（yum）"><a href="#Linux-将-Git-更新至最新版本（yum）" class="headerlink" title="Linux 将 Git 更新至最新版本（yum）"></a>Linux 将 Git 更新至最新版本（yum）</h2><h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>Centos 7 服务器上默认安装的 Git 是 1.8.3.1 版本的，用 VSCode 远程连接服务器时，一直提示我更新到 <code>2.x</code> 版本</p><h3 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h3><p>首先，把老版本的 Git 卸掉。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y remove git</span><br><span class="line">sudo yum -y remove git-*</span><br></pre></td></tr></table></figure><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h3 id="添加-End-Point-到-CentOS-7-仓库"><a href="#添加-End-Point-到-CentOS-7-仓库" class="headerlink" title="添加 End Point 到 CentOS 7 仓库"></a>添加 End Point 到 CentOS 7 仓库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install https://packages.endpointdev.com/rhel/7/os/x86_64/endpoint-repo.x86_64.rpm</span><br></pre></td></tr></table></figure><h3 id="安装-Git"><a href="#安装-Git" class="headerlink" title="安装 Git"></a>安装 Git</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install git</span><br></pre></td></tr></table></figure><h3 id="查看安装后的-Git-版本"><a href="#查看安装后的-Git-版本" class="headerlink" title="查看安装后的 Git 版本"></a>查看安装后的 Git 版本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git version</span><br><span class="line">git version 2.36.0</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
  
  
    
    
    <entry>
      <title>我是分类页</title>
      <link href="/categories/index.html"/>
      <url>/categories/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/css/custom.css"/>
      <url>/css/custom.css</url>
      
        <content type="html"><![CDATA[/* @font-face {  font-family: Candyhome;  src: url(https://npm.elemecdn.com/anzhiyu-blog@1.1.6/fonts/Candyhome.ttf);  font-display: swap;  font-weight: lighter;} */@font-face {    font-family: ZhuZiAYuanJWD;    src: url(https://npm.elemecdn.com/anzhiyu-blog@1.1.6/fonts/ZhuZiAWan.woff2);    font-display: swap;    font-weight: lighter;  }    div#menus {    font-family: 'ZhuZiAYuanJWD';  }  h1#site-title {    font-family: ZhuZiAYuanJWD;    font-size: 3em !important;  }  a.article-title,  a.blog-slider__title,  a.categoryBar-list-link,  h1.post-title {    font-family: ZhuZiAYuanJWD;  }    .iconfont {    font-family: 'iconfont' !important;    font-size: 3em;    /* 可以定义图标大小 */    font-style: normal;    -webkit-font-smoothing: antialiased;    -moz-osx-font-smoothing: grayscale;  }    /* 时间轴生肖icon */  svg.icon {    /* 这里定义svg.icon，避免和Butterfly自带的note标签冲突 */    width: 1em;    height: 1em;    /* width和height定义图标的默认宽度和高度*/    vertical-align: -0.15em;    fill: currentColor;    overflow: hidden;  }    .icon-zhongbiao::before {    color: #f7c768;  }      /* 解决artitalk的图标问题 */  #uploadSource > svg {    width: 1.19em;    height: 1.5em;  }    /*top-img黑色透明玻璃效果移除，不建议加，除非你执着于完全一图流或者背景图对比色明显 */  #page-header:not(.not-top-img):before {    background-color: transparent !important;  }    /* 首页文章卡片 */  #recent-posts > .recent-post-item {    background: rgba(255, 255, 255, 0.9);  }    /* 首页侧栏卡片 */  #aside-content .card-widget {    background: rgba(255, 255, 255, 0.9);  }    /* 文章页面正文背景 */  div#post {    background: rgba(255, 255, 255, 0.9);  }    /* 分页页面 */  div#page {    background: rgba(255, 255, 255, 0.9);  }    /* 归档页面 */  div#archive {    background: rgba(255, 255, 255, 0.9);  }    /* 标签页面 */  div#tag {    background: rgba(255, 255, 255, 0.9);  }    /* 分类页面 */  div#category {    background: rgba(255, 255, 255, 0.9);  }    /*夜间模式伪类遮罩层透明*/  [data-theme='dark'] #recent-posts > .recent-post-item {    background: #121212;  }    [data-theme='dark'] .card-widget {    background: #121212 !important;  }    [data-theme='dark'] div#post {    background: #121212 !important;  }    [data-theme='dark'] div#tag {    background: #121212 !important;  }    [data-theme='dark'] div#archive {    background: #121212 !important;  }    [data-theme='dark'] div#page {    background: #121212 !important;  }    [data-theme='dark'] div#category {    background: #121212 !important;  }    [data-theme='dark'] div#category {    background: transparent !important;  }  /* 页脚透明 */  #footer {    background: transparent !important;  }    /* 头图透明 */  #page-header {    background: transparent !important;  }    #rightside > div > button {    border-radius: 5px;  }    /* 滚动条 */    ::-webkit-scrollbar {    width: 10px;    height: 10px;  }    ::-webkit-scrollbar-thumb {    background-color: #425aef;    border-radius: 2em;  }    ::-webkit-scrollbar-corner {    background-color: transparent;  }    ::-moz-selection {    color: #fff;    background-color: #425aef;  }    /* 音乐播放器 */    /* .aplayer .aplayer-lrc {    display: none !important;  } */    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {    left: -66px !important;    transition: all 0.3s;    /* 默认情况下缩进左侧66px，只留一点箭头部分 */  }    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {    left: 0 !important;    transition: all 0.3s;    /* 鼠标悬停是左侧缩进归零，完全显示按钮 */  }    .aplayer.aplayer-fixed {    z-index: 999999 !important;  }    /* 评论框  */  .vwrap {    box-shadow: 2px 2px 5px #bbb;    background: rgba(255, 255, 255, 0.3);    border-radius: 8px;    padding: 30px;    margin: 30px 0px 30px 0px;  }    /* 设置评论框 */    .vcard {    box-shadow: 2px 2px 5px #bbb;    background: rgba(255, 255, 255, 0.3);    border-radius: 8px;    padding: 30px;    margin: 30px 0px 0px 0px;  }    /* 鼠标图标 */  body {    cursor: url('/img/x1.cur'), auto;  }  a,  [type='button']:not(:disabled),  [type='reset']:not(:disabled),  [type='submit']:not(:disabled),  button:not(:disabled) {    cursor: url('/img/x2.cur'), auto !important;  }  /* md网站下划线 */  #article-container a:hover {    text-decoration: none !important;  }    #article-container #hpp_talk p img {    display: inline;  }    /* 404页面 */  #error-wrap {    position: absolute;    top: 40%;    right: 0;    left: 0;    margin: 0 auto;    padding: 0 1rem;    max-width: 1000px;    transform: translate(0, -50%);  }    #error-wrap .error-content {    display: flex;    flex-direction: row;    justify-content: center;    align-items: center;    margin: 0 1rem;    height: 18rem;    border-radius: 8px;    background: var(--card-bg);    box-shadow: var(--card-box-shadow);    transition: all 0.3s;  }    #error-wrap .error-content .error-img {    box-flex: 1;    flex: 1;    height: 100%;    border-top-left-radius: 8px;    border-bottom-left-radius: 8px;    background-color: #425aef;    background-position: center;    background-size: cover;  }    #error-wrap .error-content .error-info {    box-flex: 1;    flex: 1;    padding: 0.5rem;    text-align: center;    font-size: 14px;    font-family: Titillium Web, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft JhengHei', 'Microsoft YaHei', sans-serif;  }  #error-wrap .error-content .error-info .error_title {    margin-top: -4rem;    font-size: 9em;  }  #error-wrap .error-content .error-info .error_subtitle {    margin-top: -3.5rem;    word-break: break-word;    font-size: 1.6em;  }  #error-wrap .error-content .error-info a {    display: inline-block;    margin-top: 0.5rem;    padding: 0.3rem 1.5rem;    background: var(--btn-bg);    color: var(--btn-color);  }    #body-wrap.error .aside-list {    display: flex;    flex-direction: row;    flex-wrap: nowrap;    bottom: 0px;    position: absolute;    padding: 1rem;    width: 100%;    overflow: scroll;  }    #body-wrap.error .aside-list .aside-list-group {    display: flex;    flex-direction: row;    flex-wrap: nowrap;    max-width: 1200px;    margin: 0 auto;  }    #body-wrap.error .aside-list .aside-list-item {    padding: 0.5rem;  }    #body-wrap.error .aside-list .aside-list-item img {    width: 100%;    object-fit: cover;    border-radius: 12px;  }    #body-wrap.error .aside-list .aside-list-item .thumbnail {    overflow: hidden;    width: 230px;    height: 143px;    background: var(--heo-card-bg);    display: flex;  }    #body-wrap.error .aside-list .aside-list-item .content .title {    -webkit-line-clamp: 2;    overflow: hidden;    display: -webkit-box;    -webkit-box-orient: vertical;    line-height: 1.5;    justify-content: center;    align-items: flex-end;    align-content: center;    padding-top: 0.5rem;    color: white;  }    #body-wrap.error .aside-list .aside-list-item .content time {    display: none;  }    /* 代码框主题 */  #article-container figure.highlight {    border-radius: 10px;  } /* 导航栏居中 */  #nav-right{    flex:1 1 auto;    justify-content: flex-end;    margin-left: auto;    display: flex;    flex-wrap:nowrap;}/* 去掉导航栏底部蓝色长条动画 */#nav *::after{  background-color: transparent!important;}/* 网站标题 */#site-name::before{  opacity: 0;  background-color: var(--lyx-theme)!important;  border-radius: 8px;  -webkit-border-radius: 8px;  -moz-border-radius: 8px;  -ms-border-radius: 8px;  -o-border-radius: 8px;  transition: .3s;  -webkit-transition: .3s;  -moz-transition: .3s;  -ms-transition: .3s;  -o-transition: .3s;  position:absolute;  top:0!important;  right:0!important;  width:100%;  height:100%;  content: "\f015";  box-shadow: 0 0 5px var(--lyx-theme);  font-family: "Font Awesome 6 Free";  text-align: center;  color:white;  line-height:30px;/*如果有溢出或者垂直不居中的现象微调一下这个参数*/  font-size: 18px;/*根据个人喜好*/}#site-name:hover::before{  opacity: 1;  scale:1.03;}#site-name{  position: relative;  font-size: 24px; /*一定要把字体调大点，否则效果惨不忍睹！*/}:root{  --lyx-theme:#00ffe1 /*我的主题色*/}/* 显示标题 */.nav-fixed #nav{  transform: translateY(58px)!important;  -webkit-transform: translateY(58px)!important;  -moz-transform: translateY(58px)!important;  -ms-transform: translateY(58px)!important;  -o-transform: translateY(58px)!important;}#nav{  transition: none!important;  -webkit-transition: none!important;  -moz-transition: none!important;  -ms-transition: none!important;  -o-transition: none!important;}#page-name::before{  font-size:18px;  position: absolute;  width:100%;  height:100%;  border-radius: 8px;  color:rgb(255, 255, 255)!important;  top:0;  left:0;  content:'回到顶部';  background-color: var(--lyx-theme);  transition: all .3s;  -webkit-transition: all .3s;  -moz-transition: all .3s;  -ms-transition: all .3s;  -o-transition: all .3s;  opacity: 0;  box-shadow: 0 0 3px var(--lyx-theme);  line-height: 45px; /*如果垂直位置不居中可以微调此值，也可以删了*/}#page-name:hover:before{  opacity: 1;}#name-container{  transition: all .3s;  -webkit-transition: all .3s;  -moz-transition: all .3s;  -ms-transition: all .3s;  -o-transition: all .3s;}#name-container:hover{  scale:1.03}#page-name{  position: relative;  padding:10px 30px/*如果文字间隔不合理可以微调修改，第二个是水平方向的padding，第一个是垂直的*/}/* tags样式 */#aside-content .card-tag-cloud a {  color: #425aef !important;  font-size: 1.05rem !important;  border-radius: 8px;  display: inline-block;  margin-right: 4px;}#aside-content .card-tag-cloud a:hover {  background: #425aef;  color: #ffffff !important;  box-shadow: var(--anzhiyu-shadow-theme);}@media screen and (min-width: 1300px) {  #aside-content .card-tag-cloud a:hover {    transform: scale(1.03);  }  #aside-content .card-tag-cloud a:active {    transform: scale(0.97);  }}#aside-content .card-tag-cloud a sup {  opacity: .4;  margin-left: 2px;}/* 归档样式 */span.card-archive-list-count {  width: auto;  text-align: left;  font-size: 1.5rem;  line-height: 0.9;  font-weight: 700;}.card-archive-list-count-group {  display: flex;  flex-direction: row;  align-items: baseline;}#aside-content .card-archives ul.card-archive-list > .card-archive-list-item a span:last-child,#aside-content .card-categories ul.card-category-list > .card-category-list-item a span:last-child {  width: fit-content;  margin-left: 4px;}span.card-archive-list-count {    width: auto;    text-align: left;    font-size: 1.1rem;    line-height: .9;    font-weight: 700;}.card-archive-list-date {  font-size: 14px;  opacity: 0.6;}li.card-archive-list-item {  width: 100%;  flex: 0 0 48%;}#aside-content .card-archives ul.card-archive-list > .card-archive-list-item a:hover,#aside-content .card-categories ul.card-category-list > .card-category-list-item a:hover {  color: #ffffff;  background-color: #425aef;  box-shadow: #000000;  border-radius: 8px;  padding-left: 0.5rem;  padding-right: 0.5rem;}@media screen and (min-width: 1300px) {  #aside-content .card-archives ul.card-archive-list > .card-archive-list-item a:hover,  #aside-content .card-categories ul.card-category-list > .card-category-list-item a:hover {    transform: scale(1.03);  }  #aside-content .card-archives ul.card-archive-list > .card-archive-list-item a:active,  #aside-content .card-categories ul.card-category-list > .card-category-list-item a:active {    transform: scale(0.97);  }}#aside-content .card-archives ul.card-archive-list > .card-archive-list-item a,#aside-content .card-categories ul.card-category-list > .card-category-list-item a {  border-radius: 8px;  margin: 4px 0;  display: flex;  flex-direction: column;  align-content: space-between;  border: 5px solid rgb(60, 60, 60);}#aside-content .card-archives ul.card-archive-list > .card-archive-list-item a span:first-child,#aside-content .card-categories ul.card-category-list > .card-category-list-item a span:first-child {  width: auto;  flex: inherit;}#aside-content .card-archives ul.card-archive-list,#aside-content .card-categories ul.card-category-list {  display: flex;  flex-direction: row;  justify-content: space-between;  flex-wrap: wrap;}#aside-content .aside-list > .aside-list-item .content > time {  display: none;}#aside-content .aside-list > .aside-list-item .content > .title {  -webkit-line-clamp: 3;  font-weight: 700;  padding: 2px 0;}#aside-content .aside-list > .aside-list-item {  padding: 8px;  padding-top: 6px !important;  padding-bottom: 6px !important;  border-radius: 12px;  transition: 0.3s;  margin: 4px 0;  cursor: pointer;}@media screen and (min-width: 1300px) {  #aside-content .aside-list > .aside-list-item:hover {    transform: scale(1.03);  }  #aside-content .aside-list > .aside-list-item:active {    transform: scale(0.97);  }}#aside-content .aside-list > .aside-list-item:hover .thumbnail > img {  transform: scale(1);}#aside-content .aside-list > .aside-list-item:not(:last-child) {  border-bottom: 0 dashed #425aef !important;}#aside-content .aside-list > .aside-list-item .thumbnail {  border-radius: 8px;  border: 5px solid rgb(60, 60, 60);}#aside-content .aside-list > .aside-list-item:hover {  background: #425aef;  color: #ffffff;  transition: 0.3s;  box-shadow: 2px 2px 10px #06C;}#aside-content .aside-list > .aside-list-item:hover a {  color: #ffffff !important;}.card-widget.card-recent-post {  padding: 0.4rem 0.6rem !important;}]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>我是友情链接</title>
      <link href="/link/index.html"/>
      <url>/link/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>我是标签页</title>
      <link href="/tags/index.html"/>
      <url>/tags/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
  
</search>
